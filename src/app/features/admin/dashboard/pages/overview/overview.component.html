@if (loading()) {
  <app-dashboard-skeleton />
} @else {
  <div class="p-6 space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Vue d'ensemble</h1>
        <p class="text-sm text-gray-600 mt-1">Synth√®se de la performance du shop</p>
      </div>
    </div>

    <!-- KPIs Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      @for (kpi of kpis(); track kpi.label) {
        <app-kpi-card [data]="kpi" />
      }
    </div>

  <!-- Main Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Revenue Chart -->
    <div class="lg:col-span-8">
      <app-chart-card
        [config]="chartConfig"
        [loading]="loading()"
        [isEmpty]="salesStore.salesData().length === 0"
        (toggleChange)="onToggleMovingAverage($event)"
      >
        @if (salesStore.salesData().length > 0) {
          <apx-chart
            [series]="revenueChartOptions().series!"
            [chart]="revenueChartOptions().chart!"
            [xaxis]="revenueChartOptions().xaxis!"
            [yaxis]="revenueChartOptions().yaxis!"
            [stroke]="revenueChartOptions().stroke!"
            [grid]="revenueChartOptions().grid!"
            [tooltip]="revenueChartOptions().tooltip!"
            [legend]="revenueChartOptions().legend!"
            [colors]="revenueChartOptions().colors!"
            [responsive]="revenueChartOptions().responsive!"
          ></apx-chart>
        }

        <app-empty-state
          empty
          [message]="'Aucune donn√©e de vente disponible'"
          [icon]="'üìä'"
        />

        <ng-template #footer>
          <p class="text-sm text-gray-600">
            Moyenne journali√®re : {{ (salesStore.totalRevenue() / salesStore.salesData().length).toFixed(0) }} ‚Ç¨
          </p>
        </ng-template>
      </app-chart-card>
    </div>

    <!-- Top Products Chart -->
    <div class="lg:col-span-4">
      <app-chart-card
        [config]="topProductsConfig"
        [loading]="loading()"
        [isEmpty]="salesStore.topProducts().length === 0"
      >
        @if (salesStore.topProducts().length > 0) {
          <apx-chart
            [series]="topProductsChartOptions().series!"
            [chart]="topProductsChartOptions().chart!"
            [xaxis]="topProductsChartOptions().xaxis!"
            [plotOptions]="topProductsChartOptions().plotOptions!"
            [dataLabels]="topProductsChartOptions().dataLabels!"
            [colors]="topProductsChartOptions().colors!"
            [grid]="topProductsChartOptions().grid!"
          ></apx-chart>
        }

        <app-empty-state
          empty
          [message]="'Aucune donn√©e produit disponible'"
          [icon]="'üì¶'"
        />
      </app-chart-card>
    </div>
  </div>

  <!-- Alerts Section -->
  @if (alerts().length > 0) {
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
        <i class="fa-solid fa-triangle-exclamation text-2xl text-orange-500"></i>
        Alertes actives
      </h2>

      <div class="space-y-3">
        @for (alert of alerts(); track alert.id) {
          <div
            [class]="getSeverityClass(alert.severity)"
            class="px-4 py-3 rounded-lg border flex items-start gap-3"
            role="alert"
          >
            <div class="flex-1">
              <p class="text-sm font-medium">{{ alert.message }}</p>
              <p class="text-xs mt-1 opacity-75">
                {{ alert.timestamp | date: 'dd/MM/yyyy HH:mm' }}
              </p>
            </div>
            @if (alert.productId) {
              <button
                type="button"
                class="text-xs font-medium underline hover:no-underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 rounded px-2 py-1"
                [attr.aria-label]="'Voir le produit ' + alert.productId"
              >
                Voir
              </button>
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- Quick Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg shadow-md p-6 border border-indigo-200">
      <h3 class="text-sm font-medium text-indigo-900 uppercase tracking-wide">Taux de disponibilit√©</h3>
      <p class="text-3xl font-bold text-indigo-600 mt-2">
        {{ stocksStore.availabilityRate() }}%
      </p>
      <p class="text-xs text-indigo-700 mt-2">
        {{ stocksStore.outOfStockProducts().length }} produit(s) en rupture
      </p>
    </div>

    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-md p-6 border border-green-200">
      <h3 class="text-sm font-medium text-green-900 uppercase tracking-wide">Rotation moyenne</h3>
      <p class="text-3xl font-bold text-green-600 mt-2">
        {{ stocksStore.averageRotationRate() }} j
      </p>
      <p class="text-xs text-green-700 mt-2">
        Temps moyen avant vente
      </p>
    </div>

    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-md p-6 border border-purple-200">
      <h3 class="text-sm font-medium text-purple-900 uppercase tracking-wide">Produits en d√©clin</h3>
      <p class="text-3xl font-bold text-purple-600 mt-2">
        {{ salesStore.decliningProducts().length }}
      </p>
      <p class="text-xs text-purple-700 mt-2">
        Baisse > 20% sur la p√©riode
      </p>
    </div>
  </div>
  </div>
}
